////  LoginViewController.m//  Expresso////  Created by David Cortés Fulla on 01/12/10.//  Copyright 2010 Facultat d'Informatica de Barcelona (UPC). All rights reserved.//#import "ExpressoAppDelegate.h"#import "LoginViewController.h"#import "XML2NSDictionary.h"//#import "MerdaViewController.h"@implementation LoginViewController@synthesize nombre;@synthesize contrasena;@synthesize inicia;#pragma mark -#pragma mark Controlador de l'inici de sessió- (IBAction)iniciaSessio{	NSLog(@"Botó apretat");	NSString *nom = [nombre text];	NSString *pass = [contrasena text];		NSLog(@"%@",nom);	NSLog(@"%@",pass);		responseData = [[NSMutableData data] retain];		NSMutableURLRequest *request = [NSMutableURLRequest                                     requestWithURL:[NSURL URLWithString:@"https://expresso.webservice/orders/ident_client"]];		NSString *params = [[[NSString alloc] initWithFormat:@"user=%@&pass=%@",nom,pass] autorelease];	NSLog(@"%@",params);	[request setHTTPMethod:@"POST"];	[request setHTTPBody:[params dataUsingEncoding:NSUTF8StringEncoding]];	[[NSURLConnection alloc] initWithRequest:request delegate:self];		//[params release];	}#pragma mark -#pragma mark Delegat del NSURLConnection- (void)connection:(NSURLConnection *)connection didReceiveData:(NSData *)data{		NSString *datos = [[[NSString alloc]  initWithBytes:[data bytes]												length:[data length] encoding: NSUTF8StringEncoding] autorelease];	NSLog(@"datos: %@",datos);					/**************     INICI DEL PARSER DE LOGIN     **************/		XML2NSDictionary* parseDelegateLogin = [[XML2NSDictionary alloc] init];	NSXMLParser *parserLogin = [[NSXMLParser alloc] initWithData:data];		//Establim l'XML2Dictionary com a delegate	parserLogin.delegate = parseDelegateLogin;		//Parsejem	[parserLogin parse];			NSLog(@"%@",[parseDelegateLogin.result class]);	NSMutableDictionary *login = parseDelegateLogin.result;	NSString *result = [[NSString alloc] initWithFormat:@"%@",[[parseDelegateLogin.result valueForKey:@"login_action"]																objectForKey:@"result"]];	//Login OK!	if ([result isEqualToString: @"1"]){		NSString *credits = (NSString*)[[parseDelegateLogin.result valueForKey:@"login_action"]																   objectForKey:@"credits"];		float creditsInt = [credits floatValue];				NSString *idSessio = (NSString*)[[parseDelegateLogin.result valueForKey:@"login_action"]										objectForKey:@"sessio"];		NSLog(@"%@",idSessio);		NSLog(@"%@",result);		NSLog(@"%f",creditsInt);		/*********************** Descomentar per veure els credits en un alert ****				UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Login OK" 														message:[NSString stringWithFormat: @"Molt bé, tens %.1f € per gastar",creditsInt]													   delegate:nil 											  cancelButtonTitle:@"Acceptar" 											  otherButtonTitles: nil];		[alert show];		 		 **************************************************************************/				ExpressoAppDelegate *appDelegate = [[UIApplication sharedApplication] delegate];		[appDelegate setCredits:[NSNumber numberWithFloat:creditsInt]];		[appDelegate setUsuari:[nombre text]];		[appDelegate setIdSessio:idSessio];						[appDelegate setContrasenya:[contrasena text]];		[appDelegate actualitzaVistes];				[self dismissModalViewControllerAnimated:YES];	}	else{			//Avisar que el login no ha anat OK				NSString *error = (NSString*)[[parseDelegateLogin.result valueForKey:@"login_action"]										objectForKey:@"message"];		NSLog(@"ERROR!!:%@",error);								UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Error" 														message:error													   delegate:nil 											  cancelButtonTitle:@"Acceptar" 											  otherButtonTitles: nil];		[alert show];		nombre.text = @"";		contrasena.text = @"";	}		[parseDelegateLogin release];		[parserLogin release];	[login release];//[unrecognizedObjectLogin release];		/**************     FI DEL PARSER DE LOGIN     **************/					/**************		DEMO XML2Dictionary	       **************		//Inicialitzem el parserDelegate i les dades de l'acces url	XML2NSDictionary* parseDelegate = [[XML2NSDictionary alloc] init];	NSURL *url = [[NSURL alloc] initWithString:@"http://expresso.webservice/orders/get_carta"];	NSXMLParser *parser = [[NSXMLParser alloc] initWithContentsOfURL:url];		//Establim l'XML2Dictionary com a delegate	parser.delegate = parseDelegate;		//Parsejem	[parser parse];	//Naveguem pel resultat del parseig	//NSLog(@"%@",[parseDelegate.result class]);	NSMutableDictionary *carta = parseDelegate.result;	NSObject *unrecognizedObject = [[[parseDelegate.result valueForKey:@"carta"] 									valueForKey:@"productes"] 									objectAtIndex:0];				NSArray *arrResult = [(NSMutableDictionary*)unrecognizedObject allValues];	//NSLog(@"Keys: %@", [arrResult componentsJoinedByString:@" "]);	[parseDelegate release];		[url release];	[parser release];	[carta release];	[unrecognizedObject release];	/*********************************************************/		/*************	A descomentar quan hi hagi algo amb que navegar *****************	ExpressoAppDelegate *appDelegate = (ExpressoAppDelegate*)[[UIApplication sharedApplication] delegate];		MerdaViewController *merdaVC = [[MerdaViewController alloc] initWithNibName:@"MerdaViewController" bundle:nil];	[appDelegate.navigationController pushViewController:merdaVC animated:YES];	/********************************************************************************/}- (void)connection:(NSURLConnection *)connection didFailWithError:(NSError *)error{	NSLog(@"%@",error);		UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"Error" 													message:[NSString stringWithFormat:@"%@",error]												   delegate:nil 										  cancelButtonTitle:@"Acceptar" 										  otherButtonTitles: nil];	[alert show];}- (BOOL)connection:(NSURLConnection *)connection canAuthenticateAgainstProtectionSpace:(NSURLProtectionSpace *)protectionSpace {	return [protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust];}- (void)connection:(NSURLConnection *)connection didReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge {	if ([challenge.protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust])		if ([[NSString stringWithFormat:@"%@",challenge.protectionSpace.host] isEqualToString:@"expresso.webservice"])			[challenge.sender useCredential:[NSURLCredential credentialForTrust:challenge.protectionSpace.serverTrust] forAuthenticationChallenge:challenge];		[challenge.sender continueWithoutCredentialForAuthenticationChallenge:challenge];}	/* // The designated initializer.  Override if you create the controller programmatically and want to perform customization that is not appropriate for viewDidLoad. - (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil { if ((self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil])) { // Custom initialization } return self; } */#pragma mark -#pragma mark View Controller Lifecycle // Implement viewDidLoad to do additional setup after loading the view, typically from a nib. - (void)viewDidLoad { [super viewDidLoad];	 self.navigationItem.title = @"First View!";	 NSLog(@"arriba aqui"); } /* // Override to allow orientations other than the default portrait orientation. - (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation { // Return YES for supported orientations return (interfaceOrientation == UIInterfaceOrientationPortrait); } */- (void)didReceiveMemoryWarning {    // Releases the view if it doesn't have a superview.    [super didReceiveMemoryWarning];        // Release any cached data, images, etc that aren't in use.}- (void)viewDidUnload {    [super viewDidUnload];    // Release any retained subviews of the main view.    // e.g. self.myOutlet = nil;}- (void)dealloc {    [super dealloc];}@end